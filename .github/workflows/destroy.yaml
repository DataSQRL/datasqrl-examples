name: destroy-terraform-stack

'on': 
  workflow_dispatch:
    inputs:
      tf_script_dir:
        description: Path to directory where terraform scripts are stored
        required: false
        default: datasqrl-examples/finance-credit-card-chatbot/mock_tf_build_deploy

jobs:
  destroy_tf_stack:
    name: DestroyInfrastructure
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      actions: read
    env:
      ENV: DEV
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: '${{ secrets.AWS_DEV_GITHUB_ACTION_ROLE }}'
          aws-region: us-east-1
      - name: Getting Code
        uses: actions/checkout@v3
      - name: Set up SSH
        id: ssh_setup
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: '${{ secrets.SSH_KEY_SQRL_CLOUD }}'
      - name: Terraform Destroy
        id: apply
        run: >
          echo {{ inputs.tf_script_dir }}
          cd /home/runner/work/datasqrl-examples/{{ inputs.tf_script_dir }}

          docker run --env AWS_ACCESS_KEY_ID --env AWS_SECRET_ACCESS_KEY --env AWS_SESSION_TOKEN --env AWS_REGION -v ~/.ssh:/root/.ssh -v "$(pwd)":/app -v /var/run/docker.sock:/var/run/docker.sock public.ecr.aws/j5u7a3j2/datasqrl/cloud:latest terraform init -backend-config='bucket=sqrl-examples-artifactory-dev' -backend-config='key=datasqrl-examples/finance-credit-card-chatbot/package-analytics-no-chat' -backend-config='region=us-east-1'
          docker run --env AWS_ACCESS_KEY_ID --env AWS_SECRET_ACCESS_KEY --env AWS_SESSION_TOKEN --env AWS_REGION -v ~/.ssh:/root/.ssh -v "$(pwd)":/app public.ecr.aws/j5u7a3j2/datasqrl/cloud:latest terraform destroy --auto-approve
        shell: bash